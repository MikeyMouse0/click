<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>WikiSearch — Поиск статей</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      -webkit-text-size-adjust: 100%;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background-color: #f3f4f6;
    }

    /* Анимации */
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Модальное окно */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: flex-start;
      z-index: 100;
      padding: 10px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 16px;
      border-radius: 10px;
      max-height: 90vh;
      overflow-y: auto;
      width: 100%;
      max-width: 100%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      cursor: pointer;
      font-size: 1.8rem;
      color: #6b7280;
      background: none;
      border: none;
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .back-btn, .download-btn {
      margin-bottom: 12px;
      font-weight: 600;
      cursor: pointer;
      padding: 8px 14px;
      border-radius: 8px;
      transition: all 0.2s ease;
      font-size: 0.95rem;
      border: none;
    }

    .back-btn {
      color: #2563eb;
      background: transparent;
      margin-right: 8px;
    }

    .back-btn:hover {
      background-color: #e0e7ff;
    }

    .download-btn {
      background-color: #10b981;
      color: white;
    }

    .download-btn:hover {
      background-color: #059669;
    }

    /* Настройки */
    .settings-icon {
      cursor: pointer;
      transition: transform 0.3s;
      width: 24px;
      height: 24px;
    }

    .settings-icon:hover {
      transform: rotate(90deg);
    }

    .settings-panel {
      position: fixed;
      top: 60px;
      right: 12px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 110;
      display: none;
      width: 260px;
    }

    .settings-panel label {
      display: block;
      margin-bottom: 12px;
      font-size: 0.95rem;
    }

    .settings-panel h3 {
      font-weight: 600;
      margin-bottom: 12px;
      border-bottom: 1px solid #f3f4f6;
      padding-bottom: 6px;
      font-size: 1rem;
    }

    /* Карточки статей */
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
      overflow: hidden;
      cursor: pointer;
      margin-bottom: 16px;
    }

    .card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .thumbnail {
      width: 100%;
      height: 160px;
      object-fit: cover;
    }

    .card-body {
      padding: 14px;
    }

    .card-title {
      font-weight: 600;
      font-size: 1.05rem;
      color: #2563eb;
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .card-excerpt {
      font-size: 0.9rem;
      color: #4b5563;
      line-height: 1.4;
    }

    /* Выбор языка */
    .language-selector {
      position: relative;
      margin-left: 8px;
    }

    .language-btn {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .language-btn:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .flag-icon {
      width: 20px;
      height: 15px;
      margin-right: 8px;
      border-radius: 2px;
      border: 1px solid #e5e7eb;
    }

    .language-dropdown {
      position: absolute;
      right: 0;
      top: 100%;
      background-color: white;
      min-width: 180px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      z-index: 50;
      border-radius: 8px;
      padding: 8px 0;
      border: 1px solid #e5e7eb;
      margin-top: 6px;
      display: none;
      animation: fadeIn 0.2s ease-out;
    }

    .language-dropdown.show {
      display: block;
    }

    .language-option {
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      font-size: 0.9rem;
    }

    .language-option:hover {
      background-color: #f9fafb;
    }

    /* Адаптивные стили */
    @media (max-width: 640px) {
      header .container {
        flex-direction: column;
        padding: 12px;
      }
      
      #search-form {
        width: 100%;
        margin: 12px 0;
      }
      
      .hero h2 {
        font-size: 1.4rem;
      }
      
      .hero p {
        font-size: 0.95rem;
      }
      
      .search-example {
        font-size: 0.85rem;
      }
      
      .modal-content {
        padding: 14px;
      }
      
      .thumbnail {
        height: 140px;
      }
      
      .settings-panel {
        width: 90%;
        right: 5%;
        top: 70px;
      }
      
      .language-btn {
        padding: 6px 8px;
      }
      
      .flag-icon {
        width: 18px;
        height: 13px;
      }
    }

    @media (min-width: 641px) and (max-width: 768px) {
      .thumbnail {
        height: 180px;
      }
    }

    /* Улучшения для touch-устройств */
    button, .card, .language-option {
      -webkit-tap-highlight-color: transparent;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Шапка -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row items-center">
      <h1 class="text-xl sm:text-2xl font-bold text-blue-600 mb-2 sm:mb-0 sm:mr-4">WikiSearch</h1>

      <form id="search-form" class="relative w-full sm:max-w-lg mx-0 sm:mx-4">
        <input 
          type="text" 
          id="search-input" 
          placeholder="Поиск статей..." 
          class="w-full p-2.5 sm:p-3 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-sm sm:text-base"
          autocomplete="off"
        />
        <svg class="absolute left-3 top-3 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </form>

      <div class="flex items-center mt-3 sm:mt-0 w-full sm:w-auto justify-between sm:justify-normal">
        <!-- Выбор языка -->
        <div class="language-selector">
          <button class="language-btn" onclick="toggleLanguageDropdown()">
            <img id="current-language-flag" src="https://flagcdn.com/ru.svg" class="flag-icon">
            <span id="current-language-name" class="hidden sm:inline">Русский</span>
          </button>
          <div id="language-dropdown" class="language-dropdown">
            <div class="language-option" onclick="changeLanguage('ru', 'Русский')">
              <img src="https://flagcdn.com/ru.svg" class="flag-icon mr-2"> Русский
            </div>
            <div class="language-option" onclick="changeLanguage('en', 'English')">
              <img src="https://flagcdn.com/gb.svg" class="flag-icon mr-2"> English
            </div>
            <div class="language-option" onclick="changeLanguage('de', 'Deutsch')">
              <img src="https://flagcdn.com/de.svg" class="flag-icon mr-2"> Deutsch
            </div>
            <div class="language-option" onclick="changeLanguage('fr', 'Français')">
              <img src="https://flagcdn.com/fr.svg" class="flag-icon mr-2"> Français
            </div>
            <div class="language-option" onclick="changeLanguage('es', 'Español')">
              <img src="https://flagcdn.com/es.svg" class="flag-icon mr-2"> Español
            </div>
            <div class="language-option" onclick="changeLanguage('zh', '中文')">
              <img src="https://flagcdn.com/cn.svg" class="flag-icon mr-2"> 中文
            </div>
          </div>
        </div>

        <!-- Настройки -->
        <div class="relative ml-2">
          <button onclick="toggleSettings()" class="p-1 rounded-full hover:bg-gray-100">
            <svg class="settings-icon w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </button>

          <div id="settings-panel" class="settings-panel">
            <h3 id="settings-title">Настройки</h3>
            <label>
              <input type="radio" name="viewMode" value="default" checked onchange="changeViewMode(this.value)">
              <span id="view-mode-default">Обычный вид</span>
            </label>
            <label>
              <input type="radio" name="viewMode" value="wiki" onchange="changeViewMode(this.value)">
              <span id="view-mode-wiki">Как на Вики</span>
            </label>
            
            <h3 id="search-language-title">Язык поиска</h3>
            <select id="search-language-select" class="w-full p-2 border rounded text-sm">
              <option value="ru">Русский</option>
              <option value="en">English</option>
              <option value="de">Deutsch</option>
              <option value="fr">Français</option>
              <option value="es">Español</option>
              <option value="zh">中文</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Приветствие -->
  <section class="hero px-4 py-6 sm:py-8">
    <h2 id="welcome-title" class="text-xl sm:text-2xl font-bold text-center">Добро пожаловать в WikiSearch!</h2>
    <p id="welcome-text" class="text-sm sm:text-base text-center mt-2 text-gray-600">Ищите и читайте статьи из Википедии прямо здесь.</p>
    <div id="search-example" class="search-example text-xs sm:text-sm mt-3">например: Москва, Эйнштейн, Природа</div>
  </section>

  <!-- Основное содержимое -->
  <main class="container mx-auto px-3 sm:px-4 pb-8">
    <section id="results-section" class="fade-in">
      <h2 id="results-title" class="text-lg sm:text-xl font-semibold mb-4 px-2">Результаты поиска:</h2>
      <div id="results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
        <!-- Результаты будут здесь -->
      </div>
    </section>
  </main>

  <!-- Модальное окно статьи -->
  <div id="article-modal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">&times;</button>
      <div class="flex flex-wrap">
        <button class="back-btn hidden" onclick="goBack()" id="back-btn">← Назад</button>
        <button id="download-pdf-btn" class="download-btn hidden" onclick="downloadPDF()">
          <span id="download-pdf-text">Скачать PDF</span>
        </button>
      </div>
      <h2 id="modal-title" class="text-xl sm:text-2xl font-bold mb-3 mt-2"></h2>
      <img id="modal-image" class="thumbnail w-full rounded-lg mb-3 max-h-60 sm:max-h-80 object-cover" src="" alt="Изображение статьи">
      <div id="modal-extract" class="text-gray-700 text-sm sm:text-base leading-relaxed"></div>
      <iframe id="wiki-iframe" class="wiki-frame hidden w-full rounded-lg border border-gray-200 mt-3" style="height: 70vh;"></iframe>
    </div>
  </div>

  <script>
    // Локализация
    const translations = {
      ru: {
        welcomeTitle: "Добро пожаловать в WikiSearch!",
        welcomeText: "Ищите и читайте статьи из Википедии прямо здесь.",
        searchExample: "например: Москва, Эйнштейн, Природа",
        searchPlaceholder: "Поиск статей...",
        resultsTitle: "Результаты поиска:",
        noResults: "Ничего не найдено.",
        loadError: "Не удалось загрузить результаты.",
        articleError: "Не удалось загрузить статью.",
        noText: "Нет доступного текста.",
        backButton: "← Назад",
        downloadPdf: "Скачать PDF",
        settingsTitle: "Настройки",
        viewModeDefault: "Обычный вид",
        viewModeWiki: "Как на Вики",
        searchLanguageTitle: "Язык поиска"
      },
      en: {
        welcomeTitle: "Welcome to WikiSearch!",
        welcomeText: "Search and read Wikipedia articles right here.",
        searchExample: "e.g.: Moscow, Einstein, Nature",
        searchPlaceholder: "Search articles...",
        resultsTitle: "Search results:",
        noResults: "No results found.",
        loadError: "Failed to load results.",
        articleError: "Failed to load article.",
        noText: "No available text.",
        backButton: "← Back",
        downloadPdf: "Download PDF",
        settingsTitle: "Settings",
        viewModeDefault: "Default view",
        viewModeWiki: "Like on Wiki",
        searchLanguageTitle: "Search language"
      },
      de: {
        welcomeTitle: "Willkommen bei WikiSearch!",
        welcomeText: "Suchen und lesen Sie Wikipedia-Artikel direkt hier.",
        searchExample: "z.B.: Moskau, Einstein, Natur",
        searchPlaceholder: "Artikel suchen...",
        resultsTitle: "Suchergebnisse:",
        noResults: "Keine Ergebnisse gefunden.",
        loadError: "Ergebnisse konnten nicht geladen werden.",
        articleError: "Artikel konnte nicht geladen werden.",
        noText: "Kein verfügbarer Text.",
        backButton: "← Zurück",
        downloadPdf: "PDF herunterladen",
        settingsTitle: "Einstellungen",
        viewModeDefault: "Standardansicht",
        viewModeWiki: "Wie auf Wiki",
        searchLanguageTitle: "Suchsprache"
      },
      fr: {
        welcomeTitle: "Bienvenue sur WikiSearch!",
        welcomeText: "Recherchez et lisez des articles de Wikipédia directement ici.",
        searchExample: "ex.: Moscou, Einstein, Nature",
        searchPlaceholder: "Rechercher des articles...",
        resultsTitle: "Résultats de recherche:",
        noResults: "Aucun résultat trouvé.",
        loadError: "Échec du chargement des résultats.",
        articleError: "Échec du chargement de l'article.",
        noText: "Pas de texte disponible.",
        backButton: "← Retour",
        downloadPdf: "Télécharger PDF",
        settingsTitle: "Paramètres",
        viewModeDefault: "Vue par défaut",
        viewModeWiki: "Comme sur Wiki",
        searchLanguageTitle: "Langue de recherche"
      },
      es: {
        welcomeTitle: "¡Bienvenido a WikiSearch!",
        welcomeText: "Busca y lee artículos de Wikipedia directamente aquí.",
        searchExample: "ej.: Moscú, Einstein, Naturaleza",
        searchPlaceholder: "Buscar artículos...",
        resultsTitle: "Resultados de búsqueda:",
        noResults: "No se encontraron resultados.",
        loadError: "Error al cargar los resultados.",
        articleError: "Error al cargar el artículo.",
        noText: "No hay texto disponible.",
        backButton: "← Atrás",
        downloadPdf: "Descargar PDF",
        settingsTitle: "Configuración",
        viewModeDefault: "Vista predeterminada",
        viewModeWiki: "Como en Wiki",
        searchLanguageTitle: "Idioma de búsqueda"
      },
      zh: {
        welcomeTitle: "欢迎使用WikiSearch!",
        welcomeText: "在这里直接搜索和阅读维基百科文章。",
        searchExample: "例如：莫斯科，爱因斯坦，自然",
        searchPlaceholder: "搜索文章...",
        resultsTitle: "搜索结果:",
        noResults: "未找到结果。",
        loadError: "加载结果失败。",
        articleError: "加载文章失败。",
        noText: "没有可用文本。",
        backButton: "← 返回",
        downloadPdf: "下载PDF",
        settingsTitle: "设置",
        viewModeDefault: "默认视图",
        viewModeWiki: "维基样式",
        searchLanguageTitle: "搜索语言"
      }
    };

    // Элементы DOM
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('search-input');
    const resultsContainer = document.getElementById('results');
    const modal = document.getElementById('article-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalImage = document.getElementById('modal-image');
    const modalExtract = document.getElementById('modal-extract');
    const wikiIframe = document.getElementById('wiki-iframe');
    const backBtn = document.getElementById('back-btn');
    const downloadPdfBtn = document.getElementById('download-pdf-btn');
    const searchLanguageSelect = document.getElementById('search-language-select');

    // Состояние приложения
    let currentViewMode = 'default';
    let currentArticleUrl = '';
    let historyStack = [];
    let historyIndex = -1;
    let currentLanguage = 'ru';
    let searchLanguage = 'ru';

    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', () => {
      // Загрузка сохраненных настроек
      const savedLanguage = localStorage.getItem('wikiSearchLanguage') || 'ru';
      const savedSearchLanguage = localStorage.getItem('wikiSearchSearchLanguage') || 'ru';
      const savedViewMode = localStorage.getItem('wikiSearchViewMode') || 'default';
      
      changeLanguage(savedLanguage, getLanguageName(savedLanguage));
      searchLanguageSelect.value = savedSearchLanguage;
      searchLanguage = savedSearchLanguage;
      
      document.querySelector(`input[name="viewMode"][value="${savedViewMode}"]`).checked = true;
      currentViewMode = savedViewMode;
    });

    // Функции для работы с языками
    function toggleLanguageDropdown() {
      document.getElementById('language-dropdown').classList.toggle('show');
    }

    function getLanguageName(code) {
      const names = {
        ru: 'Русский',
        en: 'English',
        de: 'Deutsch',
        fr: 'Français',
        es: 'Español',
        zh: '中文'
      };
      return names[code] || 'Русский';
    }

    function changeLanguage(lang, langName) {
      currentLanguage = lang;
      localStorage.setItem('wikiSearchLanguage', lang);
      updateLanguageUI();
      
      // Обновляем флаг и название языка
      const flagUrl = `https://flagcdn.com/${lang === 'zh' ? 'cn' : lang}.svg`;
      document.getElementById('current-language-flag').src = flagUrl;
      document.getElementById('current-language-name').textContent = langName;
      
      // Обновляем placeholder в поиске
      searchInput.placeholder = translations[lang].searchPlaceholder;
      
      // Если был выполнен поиск, обновляем результаты
      if (searchInput.value.trim().length > 0) {
        searchArticles(searchInput.value.trim());
      }
    }

    function updateLanguageUI() {
      const lang = translations[currentLanguage];
      
      // Обновляем все текстовые элементы
      document.getElementById('welcome-title').textContent = lang.welcomeTitle;
      document.getElementById('welcome-text').textContent = lang.welcomeText;
      document.getElementById('search-example').textContent = lang.searchExample;
      document.getElementById('results-title').textContent = lang.resultsTitle;
      document.getElementById('back-btn').textContent = lang.backButton;
      document.getElementById('download-pdf-text').textContent = lang.downloadPdf;
      document.getElementById('settings-title').textContent = lang.settingsTitle;
      document.getElementById('view-mode-default').textContent = lang.viewModeDefault;
      document.getElementById('view-mode-wiki').textContent = lang.viewModeWiki;
      document.getElementById('search-language-title').textContent = lang.searchLanguageTitle;
    }

    // Закрываем выпадающие списки при клике вне их
    window.addEventListener('click', (e) => {
      if (!e.target.closest('.language-selector')) {
        const dropdown = document.getElementById('language-dropdown');
        if (dropdown.classList.contains('show')) {
          dropdown.classList.remove('show');
        }
      }
      
      if (!e.target.closest('.settings-icon') && !e.target.closest('.settings-panel')) {
        const panel = document.getElementById('settings-panel');
        if (panel.style.display === 'block') {
          panel.style.display = 'none';
        }
      }
    });

    // Обработчик изменения языка поиска
    searchLanguageSelect.addEventListener('change', (e) => {
      searchLanguage = e.target.value;
      localStorage.setItem('wikiSearchSearchLanguage', searchLanguage);
      
      // Если был выполнен поиск, обновляем результаты
      if (searchInput.value.trim().length > 0) {
        searchArticles(searchInput.value.trim());
      }
    });

    function toggleSettings() {
      const panel = document.getElementById('settings-panel');
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }

    function changeViewMode(mode) {
      currentViewMode = mode;
      localStorage.setItem('wikiSearchViewMode', mode);

      if (mode === 'wiki') {
        modalExtract.classList.add('hidden');
        wikiIframe.classList.remove('hidden');
        modalImage.classList.add('hidden');
        downloadPdfBtn.classList.add('hidden');
        if (currentArticleUrl) {
          wikiIframe.src = currentArticleUrl;
        }
      } else {
        wikiIframe.classList.add('hidden');
        modalExtract.classList.remove('hidden');
        modalImage.classList.remove('hidden');
        downloadPdfBtn.classList.remove('hidden');
      }
    }

    function openArticle(title) {
      const encodedTitle = encodeURIComponent(title).replace(/ /g, '_');
      const url = `https://${searchLanguage}.wikipedia.org/wiki/${encodedTitle}`;
      currentArticleUrl = url;

      // Обновление истории
      if (historyIndex < historyStack.length - 1) {
        historyStack = historyStack.slice(0, historyIndex + 1);
      }

      historyStack.push({ title, url });
      historyIndex++;

      updateNavigationButtons();

      if (currentViewMode === 'wiki') {
        modalTitle.textContent = title;
        modalExtract.classList.add('hidden');
        wikiIframe.classList.remove('hidden');
        modalImage.classList.add('hidden');
        wikiIframe.src = url;
      } else {
        loadDefaultView(title, encodedTitle);
      }

      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    async function loadDefaultView(title, encodedTitle) {
      try {
        const apiUrl = `https://${searchLanguage}.wikipedia.org/w/api.php?action=query&prop=extracts|pageimages&pithumbsize=600&titles=${encodedTitle}&exintro=1&explaintext=1&format=json&origin=*`;
        const response = await fetch(apiUrl);
        const data = await response.json();
        const pageId = Object.keys(data.query.pages)[0];
        const page = data.query.pages[pageId];

        modalTitle.textContent = page.title;
        modalExtract.innerHTML = `<p>${page.extract || translations[currentLanguage].noText}</p>`;
        modalExtract.classList.remove('hidden');
        wikiIframe.classList.add('hidden');

        if (page.thumbnail && page.thumbnail.source) {
          modalImage.src = page.thumbnail.source;
          modalImage.classList.remove('hidden');
        } else {
          modalImage.classList.add('hidden');
        }
      } catch (error) {
        console.error("Ошибка загрузки статьи:", error);
        modalExtract.innerHTML = `<p>${translations[currentLanguage].articleError}</p>`;
      }
    }

    function goBack() {
      if (historyIndex > 0) {
        historyIndex--;
        const article = historyStack[historyIndex];
        const encodedTitle = encodeURIComponent(article.title).replace(/ /g, '_');

        currentArticleUrl = article.url;

        if (currentViewMode === 'wiki') {
          modalTitle.textContent = article.title;
          wikiIframe.src = article.url;
        } else {
          loadDefaultView(article.title, encodedTitle);
        }

        updateNavigationButtons();
      }
    }

    function updateNavigationButtons() {
      backBtn.classList.toggle('hidden', historyIndex <= 0);
    }

    function closeModal() {
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    // Поиск статей
    async function searchArticles(query) {
      const url = `https://${searchLanguage}.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`;

      try {
        const response = await fetch(url);
        const data = await response.json();
        const results = data.query?.search || [];

        displayResults(results);
      } catch (error) {
        console.error("Ошибка при поиске:", error);
        resultsContainer.innerHTML = `<p class="px-2">${translations[currentLanguage].loadError}</p>`;
      }
    }

    // Отображение результатов
    function displayResults(results) {
      resultsContainer.innerHTML = '';

      if (results.length === 0) {
        resultsContainer.innerHTML = `<p class="px-2">${translations[currentLanguage].noResults}</p>`;
        return;
      }

      results.forEach(result => {
        const title = result.title;
        const snippet = result.snippet.replace(/<\/?span[^>]*>/g, '');

        const card = document.createElement('div');
        card.className = "card";
        card.innerHTML = `
          <img src="https://${searchLanguage}.wikipedia.org/wiki/Special:Random/File" class="thumbnail" onError="this.style.display='none'">
          <div class="card-body">
            <h3 class="card-title">${title}</h3>
            <p class="card-excerpt">${snippet}...</p>
          </div>
        `;
        card.addEventListener('click', () => openArticle(title));
        resultsContainer.appendChild(card);
      });
    }

    // Скачивание PDF
    function downloadPDF() {
      const element = document.createElement('div');
      element.innerHTML = `
        <h1 style="font-size: 24px; margin-bottom: 10px;">${modalTitle.textContent}</h1>
        ${modalImage.src ? `<img src="${modalImage.src}" style="max-width: 100%; margin-bottom: 10px;">` : ''}
        <div style="font-size: 14px; line-height: 1.5;">${modalExtract.innerHTML}</div>
      `;

      const opt = {
        margin: 0.5,
        filename: `${modalTitle.textContent}.pdf`,
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(element).save();
    }

    // Обработка формы поиска
    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const query = searchInput.value.trim();
      if (query) {
        searchArticles(query);
      }
    });

    // Автопоиск при вводе
    let searchTimeout;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      const query = searchInput.value.trim();
      if (query.length > 2) {
        searchTimeout = setTimeout(() => {
          searchArticles(query);
        }, 500);
      } else if (query.length === 0) {
        resultsContainer.innerHTML = '';
      }
    });

    // Закрытие модального окна по клику вне контента
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Обработка изменения ориентации экрана
    window.addEventListener('orientationchange', function() {
      if (window.innerWidth < 640) {
        const iframe = document.getElementById('wiki-iframe');
        if (iframe && !iframe.classList.contains('hidden')) {
          iframe.style.height = (window.innerHeight * 0.7) + 'px';
        }
      }
    });
  </script>
</body>
                </html>
