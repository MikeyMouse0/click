<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мемы Telegram</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .header {
            background-color: #ffffff;
            padding: 15px;
            text-align: center;
            font-size: 22px;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .notification {
            text-align: center;
            color: #3b82f6;
            font-size: 16px;
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }
        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: #f9fafb;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        .form-group input[type="file"] {
            width: 100%;
            padding: 10px 0;
        }
        .form-group .checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-group input[type="checkbox"] {
            width: auto;
            accent-color: #3b82f6;
        }
        .submit-btn {
            width: 100%;
            padding: 12px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .submit-btn:hover {
            background-color: #2563eb;
        }
        .nav-bar {
            display: flex;
            justify-content: space-around;
            background-color: #ffffff;
            padding: 12px 0;
            border-top: 1px solid #e5e7eb;
            position: sticky;
            bottom: 0;
            box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.05);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #6b7280;
            font-size: 12px;
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s;
        }
        .nav-item.active {
            color: #3b82f6;
        }
        .nav-item i {
            font-size: 22px;
            margin-bottom: 4px;
        }
        @media (max-width: 600px) {
            .content {
                padding: 15px;
            }
            .header {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">Мемы Telegram</div>
    <div class="content" id="content"></div>
    <div class="nav-bar">
        <div class="nav-item active" data-tab="create" onclick="switchTab('create')">
            <i class="fas fa-plus-circle"></i> Создать
        </div>
        <div class="nav-item" data-tab="profile" onclick="switchTab('profile')">
            <i class="fas fa-user"></i> Профиль
        </div>
    </div>

    <script>
        const SERVER_URL = "http://localhost:8000"; // Замените на URL вашего сервера
        let currentUser = null;
        let sessionToken = null;

        // Проверка авторизации через Telegram WebApp
        async function authenticate() {
            if (!window.Telegram?.WebApp) {
                document.getElementById('content').innerHTML = '<p class="notification">Ошибка: Telegram WebApp недоступен. Откройте через Telegram.</p>';
                return false;
            }

            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            const initData = Telegram.WebApp.initData;

            if (!initData) {
                document.getElementById('content').innerHTML = '<p class="notification">Ошибка: Данные авторизации отсутствуют. Используйте /start в боте.</p>';
                return false;
            }

            try {
                const response = await fetch(`${SERVER_URL}/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                const result = await response.json();
                currentUser = result.user;
                sessionToken = result.session_token;
                localStorage.setItem('sessionToken', sessionToken);
                document.getElementById('content').innerHTML = `<p class="notification">Добро пожаловать, ${currentUser.name}!</p>`;
                return true;
            } catch (error) {
                console.error('Ошибка авторизации:', error);
                document.getElementById('content').innerHTML = '<p class="notification">Ошибка авторизации. Попробуйте снова.</p>';
                return false;
            }
        }

        // Шаблоны страниц
        const templates = {
            create: () => `
                <h2>Создать мем</h2>
                <div class="form-group">
                    <label>Название</label>
                    <input type="text" id="meme-title" placeholder="Введите название мема">
                </div>
                <div class="form-group">
                    <label>Описание</label>
                    <textarea id="meme-desc" placeholder="Опишите ваш мем"></textarea>
                </div>
                <div class="form-group">
                    <label>Изображение</label>
                    <input type="file" id="meme-photo" accept="image/*">
                </div>
                <div class="form-group checkbox">
                    <input type="checkbox" id="meme-nsfw">
                    <label for="meme-nsfw">18+ контент</label>
                </div>
                <button class="submit-btn" onclick="createMeme()">Создать мем</button>
            `,
            profile: () => `
                <h2>Профиль</h2>
                ${currentUser ? `
                    <p><strong>Имя:</strong> ${currentUser.name}</p>
                    <p><strong>Telegram ID:</strong> ${currentUser.telegram_id}</p>
                    <p><strong>Роль:</strong> ${currentUser.is_superadmin ? 'Суперадмин' : currentUser.is_moderator ? 'Модератор' : 'Пользователь'}</p>
                ` : '<p class="notification">Авторизуйтесь через Telegram.</p>'}
            `
        };

        // Переключение вкладок
        async function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.tab === tab) item.classList.add('active');
            });
            document.getElementById('content').innerHTML = await templates[tab]();
        }

        // Создание мема
        async function createMeme() {
            if (!currentUser || !sessionToken) {
                document.getElementById('content').innerHTML = '<p class="notification">Ошибка: Вы не авторизованы.</p>';
                setTimeout(() => switchTab('profile'), 2000);
                return;
            }

            const title = document.getElementById('meme-title').value;
            const desc = document.getElementById('meme-desc').value;
            const nsfw = document.getElementById('meme-nsfw').checked;
            const photoInput = document.getElementById('meme-photo');

            if (!title || !desc) {
                document.getElementById('content').innerHTML = '<p class="notification">Название и описание обязательны.</p>';
                setTimeout(() => switchTab('create'), 2000);
                return;
            }

            const meme = {
                title,
                description: desc,
                nsfw,
                userId: currentUser.telegram_id,
                createdAt: new Date().toISOString(),
                status: currentUser.is_moderator || currentUser.is_superadmin ? 'approved' : 'pending'
            };

            // Отправка уведомления модераторам
            if (meme.status === 'pending') {
                const notificationData = {
                    memeId: Date.now(),
                    memeTitle: meme.title,
                    authorId: currentUser.telegram_id,
                    moderators: [{ telegram_id: 6201881953, name: "Суперадмин" }] // Пример модератора
                };
                try {
                    const response = await fetch(`${SERVER_URL}/notify-moderators`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionToken}`
                        },
                        body: JSON.stringify(notificationData)
                    });
                    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                } catch (error) {
                    console.error('Ошибка уведомления модераторов:', error);
                    document.getElementById('content').innerHTML = '<p class="notification">Ошибка отправки мема на модерацию.</p>';
                    return;
                }
            }

            // Загрузка изображения (если есть)
            if (photoInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    meme.photo = e.target.result;
                    document.getElementById('content').innerHTML = `<p class="notification">Мем ${meme.status === 'approved' ? 'опубликован' : 'отправлен на модерацию'}!</p>`;
                    setTimeout(() => switchTab('create'), 2000);
                };
                reader.readAsDataURL(photoInput.files[0]);
            } else {
                document.getElementById('content').innerHTML = `<p class="notification">Мем ${meme.status === 'approved' ? 'опубликован' : 'отправлен на модерацию'}!</p>`;
                setTimeout(() => switchTab('create'), 2000);
            }
        }

        // Инициализация
        async function init() {
            const isAuthenticated = await authenticate();
            if (isAuthenticated) {
                switchTab('create');
            } else {
                switchTab('profile');
            }
        }

        init();
    </script>
</body>
</html>
